steps:
  - label: ':lipstick:'
    command: .buildkite/prettier-check.sh
  - label: ':lipstick:'
    command: .buildkite/shfmt.sh

  - wait

  - label: ':rocket: :k8s:'
    branches: 'release'
    concurrency: 1
    concurrency_group: dogfood/deploy
    commands:
      - gcloud container clusters get-credentials dogfood --zone us-central1-f --project sourcegraph-dogfood
      - kubectl apply --prune -f namespaces --recursive --context="gke_sourcegraph-dogfood_us-central1-f_dogfood"
      - kubectl config set-context --current --namespace=dogfood-k8s
      - ./kubectl-apply-all.sh --context="gke_sourcegraph-dogfood_us-central1-f_dogfood"
