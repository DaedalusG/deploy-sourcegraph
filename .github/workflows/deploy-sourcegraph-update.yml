name: Update from deploy-sourcegraph
on:
  repository_dispatch:
    types: [ deploy-sourcegraph-update ]
jobs:
  apply-change:
    runs-on: ubuntu-latest
    steps:
      - name: Report update details
        run: |
          echo "SHA:    ${{ github.event.client_payload.sha }}"
          echo "Actor:  ${{ github.event.client_payload.actor }}"
          echo "Reason: ${{ github.event.client_payload.reason }}"

      # Set up this repository and the upstream repository
      - name: Checkout
        uses: actions/checkout@v2
      - name: Set up git
        run: |
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git config --global user.name "${GITHUB_ACTOR}"
      - name: Fetch upstream
        run: |
          git remote add upstream https://github.com/sourcegraph/deploy-sourcegraph.git
          git fetch upstream

      # Set up and commit cherry-pick
      - name: Set up cherry-pick of ${{ github.event.client_payload.sha }}
        run: |
          git cherry-pick --strategy=recursive --no-commit ${{ github.event.client_payload.sha }} || true # ignore conflicts
      - name: Unstage irrelevant cherry-picked changes
        run: |
          git reset -- .github
          git reset -- *.md
      - name: Commit update - if this step fails, there are no relevant changes
        run: |
          git commit --all --no-edit

      # Get short hash for ease of use
      - name: Generate git short hash
        id: rev_parse
        run: |
          echo "::set-output name=short_hash::$(git rev-parse --short ${{ github.event.client_payload.sha }})"

      # Create pull request, configured to automatically merge
      - name: Open pull request
        uses: peter-evans/create-pull-request@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: release
          branch: deploy-sourcegraph/${{ steps.rev_parse.outputs.short_hash }}
          reviewers: ${{ github.event.client_payload.actor }}
          labels: automerge,deploy-sourcegraph
          title: 'deploy-sourcegraph@${{ steps.rev_parse.outputs.short_hash }} by ${{ github.event.client_payload.actor }}'
          body: |
            Cherry-pick of https://github.com/sourcegraph/deploy-sourcegraph/commit/${{ github.event.client_payload.sha }} (https://github.com/sourcegraph/deploy-sourcegraph/pull/${{ github.event.client_payload.pull_request }}) by [${{ github.event.client_payload.actor }}](https://github.com/${{ github.event.client_payload.actor }}).

            ---

            This automated pull request was generated by [this run](https://github.com/sourcegraph/deploy-sourcegraph-dogfood-k8s-2/actions/runs/${{ github.run_id }}).

      # Report back to originating PR that something went wrong
      - name: Report failure
        if: ${{ failure() }}
        uses: peter-evans/create-or-update-comment@v1
        with:
          repository: sourcegraph/deploy-sourcegraph
          issue-number: ${{ github.event.client_payload.pull_request }}
          body: |
            :warning: [Failed to create a PR for applying this change in the dogfood environment](https://github.com/sourcegraph/deploy-sourcegraph-dogfood-k8s-2/actions/runs/${{ github.run_id }}).
            
            /cc @sourcegraph/distribution, @${{ github.event.client_payload.actor }}
          # token must be a personal access token for cross-repo access - currently @sourcegraph-bot cross-repo-github-actions in 1password
          # token must have `repo` scope
          # configure in https://github.com/sourcegraph/deploy-sourcegraph-dogfood-k8s-2/settings/secrets/COMMENT_PERSONAL_ACCESS_TOKEN
          token: ${{ secrets.COMMENT_PERSONAL_ACCESS_TOKEN }}
