name: Update from deploy-sourcegraph
on:
  repository_dispatch:
    types: [ deploy-sourcegraph-update ]
jobs:
  apply-change:
    runs-on: ubuntu-latest
    steps:
      - name: Report update details
        run: |
          echo "SHA:    ${{ github.event.client_payload.sha }}"
          echo "Actor:  ${{ github.event.client_payload.actor }}"
          echo "Reason: ${{ github.event.client_payload.reason }}"

      - name: Checkout
        uses: actions/checkout@v2
      - name: Set up git
        run: |
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git config --global user.name "${GITHUB_ACTOR}"
      - name: Fetch upstream
        run: |
          git remote add upstream https://github.com/sourcegraph/deploy-sourcegraph.git
          git fetch upstream
      - name: Set up cherry-pick of ${{ github.event.client_payload.sha }}
        run: |
          git cherry-pick -x --no-commit ${{ github.event.client_payload.sha }}
      - name: Unstage irrelevant cherry-picked changes
        run: |
          git reset -- .github
          git reset -- *.md
      - name: Commit update - if this step fails, there are no relevant changes
        run: |
          git commit --no-edit

      - name: Open pull request
        uses: peter-evans/create-pull-request@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: release
          branch: deploy-sourcegraph/${{ github.event.client_payload.sha }}
          reviewers: ${{ github.event.client_payload.actor }}
          labels: automerge,deploy-sourcegraph
          title: 'deploy-sourcegraph: ${{ github.event.client_payload.sha }} by ${{ github.event.client_payload.actor }}'
          body: |
            Cherry-pick of https://github.com/sourcegraph/deploy-sourcegraph/commit/${{ github.event.client_payload.sha }} by @${{ github.event.client_payload.actor }}.

            This automated pull request is generated by [this run](https://github.com/sourcegraph/deploy-sourcegraph-dogfood-k8s-2/actions/runs/${{ github.run_id }}).
